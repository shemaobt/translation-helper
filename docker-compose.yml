services:
  gcp-secrets:
    image: gcr.io/google.com/cloudsdktool/google-cloud-cli:alpine
    container_name: translation-helper-gcp-secrets
    environment:
      REPO_PREFIX: translation_helper
      SECRETS_PROJECT_ID: ${SECRETS_PROJECT_ID:-shemaobt-secrets}
    volumes:
      - gcp_secrets_env:/secrets
      - ${HOME}/.config/gcloud:/root/.config/gcloud
      - ../tf/scripts:/tf/scripts:ro
    command: ["sh", "-c", "/tf/scripts/gcp_secrets_to_env.sh > /secrets/.env"]
    restart: "no"

  backend:
    build:
      context: .
      dockerfile: Dockerfile.backend
    container_name: translation-helper-backend
    environment:
      GOOGLE_APPLICATION_CREDENTIALS: /root/.config/gcloud/application_default_credentials.json
      NODE_ENV: ${NODE_ENV:-development}
      PORT: 5000
    volumes:
      - ${HOME}/.config/gcloud:/root/.config/gcloud:ro
      - gcp_secrets_env:/run/secrets:ro
    ports:
      - "5001:5000"
    depends_on:
      gcp-secrets:
        condition: service_completed_successfully
    networks:
      - translation-network
    restart: unless-stopped
    command: >
      sh -c "set -a && . /run/secrets/.env && 
             export DATABASE_URL=\"$$NEON_DATABASE_URL\" &&
             export GOOGLE_GENERATIVE_AI_API_KEY=\"$$GOOGLE_API_KEY\" &&
             set +a && node dist/index.js"

  frontend:
    build:
      context: .
      dockerfile: Dockerfile.frontend
      args:
        VITE_API_URL: http://localhost:5001
    container_name: translation-helper-frontend
    environment:
      BACKEND_URL: http://backend:5000
    ports:
      - "8080:8080"
    depends_on:
      - backend
    networks:
      - translation-network
    restart: unless-stopped

networks:
  translation-network:
    driver: bridge

volumes:
  gcp_secrets_env:
